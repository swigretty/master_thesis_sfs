\usepackage{texab}
\usepackage{amsmath}
\usepackage{latexsymb}\chapter{Methods}\label{ch:methods}

The last chapter introduced Gaussian process regression
to establish a mapping between a time point x and its
corresponding BP value.
Since Gaussian Processes are capable of modeling time series in continuous
time and hence deal with irregularly spaced data,
they seem to be a good candidate for modeling a time series from which
we only have irregularly sampled noisy measurement.
To identify how suited GPs are for the problem at hand, the plan is to:
\begin{itemize}
    \item Simulate a BP time series and some noisy measurements of the time series
    \item Estimate some target measures from these measurements.
    \item Compare the aptness of GP regression to estimate the target measures to that of some baseline methods.
    \item Investigate the impact of the sampling pattern on the target measure estimates, e.g
    How densely does the data need to be sampled to get good estimates?
    What happens if the data is not uniformly sampled across time ?
\end{itemize}

The next section will provide you with an overview of the steps involved
in quantifying the performance of a given method.


\section{Overview}

This is a list of the steps involved in assessing the performance of a given
method. More information can be found in the referenced sections:

\begin{enumerate}
    \item Simulate true BP time series at high resolution (section \ref{sec:blood-pressure-time-series-simulation})
    \item Simulate BP measurement by subsampling the true time series and adding noise (section \ref{subsec:sampling-patterns})
    \item Fit Regression (For GP Regression see section \ref{sec:gaussian-process-regression}
    for baseline methods see \ref{sec:baseline-methods})
    \item Extract target measure including CI (section \ref{sec:target-measures})
    \item Calculate performance metric between true and predicted values (section \ref{sec:performance-metric})
\end{enumerate}

\section{Blood Pressure Time Series Simulation}\label{sec:blood-pressure-time-series-simulation}

In section \ref{sec:characteristics-of-the-blood-pressure-time-series} listed
the properties the simulated BP time series process and the measurements should have.

Recall that we assume the following model for the BP measurements $Y(x)$ at a time point $x$, as
described in section \ref{sec:problem-statement}:

\begin{align*}
    Y(x) = f(x) + \epsilon && \epsilon \sim \N(0, \sigma_n^{2})
\end{align*}

The goal is to generate the true BP time series process, $f(x)$, from which
$Y(x)$ can be obtained by adding iid Gaussian measurement noise.

\subsection{Simulation of the True BP Process}

The true BP process $f(x)$ was decided to be modeled by a Gaussian process,
since GPs are flexible enough to represent the properties
specified for $f(x)$ in section \ref{sec:characteristics-of-the-blood-pressure-time-series}.

Based on section \ref{sec:characteristics-of-the-blood-pressure-time-series}
one would probably choose the mean fuction to be constant and be equal to the
global mean BP value of 120 mmHg. We have:
\begin{gather*}
    f(x) \sim GP(120, k(x,x'))
\end{gather*}
From section \ref{subsec:mean-function} we know that this is the same as writing:
\begin{gather*}
    f(x) - 120 \sim GP(0, k(x,x'))
\end{gather*}

For simplicity we are going to completely ignore this constant
mean function and write $f(x)$, although we actually mean $f(x) - 120$.

The true GP, from which we are going to draw true BP samples from has the following
form:
\begin{gather*}
    f(x) \sim GP(0, k(x,x'))
\end{gather*}
with a kernel function chosen to match the properties from
section \ref{sec:characteristics-of-the-blood-pressure-time-series}:

\begin{align*}\label{def:true_gp}
    k(x, x') \text{ } = &\text{ } 2.24^{2} * \text{Matérn(l=3, $\nu$=0.5)} \\
             &+  14^{2} * \text{Periodic(l=3, p=24)} \\
             &+  2.24^{2} * \text{RBF(l=50)}
\end{align*}
where l denotes the length scale and p denotes the periodicity
of the corresponding kernel function in hours.
The formal definition of the Matérn, Periodic and RBF kernel
functions and their parameters is provided in section \ref{sec:kernel}.

Each of these kernels models one of the components described in
\ref{sec:characteristics-of-the-blood-pressure-time-series}:
\begin{itemize}
    \item The Matérn kernel with $\nu$=0.5 models the AR(1) component
    \item The Periodic kernel models the circadian cycle
    \item The RBF kernel model a long term trend
\end{itemize}

The kernel function is illustrated in figure \ref{fig:true_kernel} and
some samples drawn form this GP are shown in Figure \ref{fig:true_gp_samples}.

\begin{figure}
    \centering
    \includegraphics[width=0.6\linewidth]{Pictures/plots_final/sin_rbf_default_0.2/09_06_09_09_17/plot_kernel_true}
    \caption{The true kernel function $k(x,x')$}
    \label{fig:true_kernel}
\end{figure}

\begin{figure}
\centering
\begin{subfigure}{.45\textwidth}
    \centering
    \includegraphics[width=\linewidth]{Pictures/plots_final/sin_rbf_default_0.05/09_06_08_59_46/plot_true_mean_decomposed}
    \includegraphics[width=\linewidth]{Pictures/plots_final/sin_rbf_default_0.05/09_06_09_00_09/plot_true_mean_decomposed}
    \includegraphics[width=\linewidth]{Pictures/plots_final/sin_rbf_default_0.05/09_06_09_00_31/plot_true_mean_decomposed}
    \includegraphics[width=\linewidth]{Pictures/plots_final/sin_rbf_default_0.05/09_06_09_00_58/plot_true_mean_decomposed}
  \caption{The sample shown to the right, decomposed in to the contribution of the Periodic kernel (orange),
      Matérn kernel (blue), RBF kernel (green).}
  \label{fig:true_mean_decomposed}
\end{subfigure}\hfill
\begin{subfigure}{.45\textwidth}
    \centering
    \includegraphics[width=\linewidth]{Pictures/plots_final/sin_rbf_default_0.05/09_06_08_59_46/plot_true_with_samples}
    \includegraphics[width=\linewidth]{Pictures/plots_final/sin_rbf_default_0.05/09_06_09_00_09/plot_true_with_samples}
    \includegraphics[width=\linewidth]{Pictures/plots_final/sin_rbf_default_0.05/09_06_09_00_31/plot_true_with_samples}
    \includegraphics[width=\linewidth]{Pictures/plots_final/sin_rbf_default_0.05/09_06_09_00_58/plot_true_with_samples}
  \caption{Each figure shows one sample drawn from the true GP (red dashed line) with noisy observations
      (red dots) sampled at a frequency of 0.5/hour}
  \label{fig:sub2}
\end{subfigure}
\caption{Samples (right side) drawn from the true GP and the decomposition of the samples (left side)}
\label{fig:true_gp_samples}
\end{figure}


\subsection{Sampling Patterns}\label{subsec:sampling-patterns}


\section{Simulation and Evaluation Flow Gaussian Process Regression}

Let us start with the following definitions:

    \begin{itemize}
        \item $X := \left[ x_0, \dots x_n \right]$: The time points of interest, which is one week of data with 10 BP values per hour.
        \item $\epsilon := \left[ \epsilon_0, \dots \epsilon_n \right] \iidsim \N(0, \sigma_n^2)$: iid measurement noise vector
        \item $k(x,x')$: The kernel function of the true GP
        \item $K_{XX} := \begin{bmatrix}
        k(x_1, x_1) & \dots & k(x_1, x_n)\\
        \vdots  &  & \vdots \\
        k(x_n, x_1) & \dots  & k(x_n, x_n)
    \end{bmatrix} $: The true kernel function evaluated at $X$
    \end{itemize}

\begin{gather*}
        K_{XX} = \begin{bmatrix}
        k(x_1, x_1) & \dots & k(x_1, x_n)\\
        \vdots  &  & \vdots \\
        k(x_n, x_1) & \dots  & k(x_n, x_n)
    \end{bmatrix}
\end{gather*}: The true kernel function evaluated at the inputs $X$


\begin{algorithm} \caption{Simulation and Evaluation Flow}
 \hspace*{\algorithmicindent} \textbf{Input:} $X$, $K_{XX}$, TargetFunction, $S$, $K$\\
 \hspace*{\algorithmicindent} \textbf{Output:} CiCoverage, CiWidth
\begin{algorithmic}[1]
    \State \textbf{Initialize:} CiCoverageList = $\left[ \text{ } \right]$, CiWidthList = $\left[ \text{ } \right]$
    \For {$s = 0$ \dots $S$}
        \State $F_X$ sample from $\N(0, K_{XX})$
        \State $i_{train}$ sample from $1 \dots \text{length}(X)$
        \State $Y_{train} = F_X\left[i_{train}\right] + \epsilon \left[i_{train}\right]$
        \State $\hat{F}_X, \hat{\Sigma}_{F_X} =$ GP.fit($Y_{train}$).predict($X$)
        \State \textbf{Initialize:} $\hat{M} = \left[ \text{ } \right]$
        \For {$k = 0$ \dots $K$}
            \State $\hat{F}_{X,k}$ sample from $\N(\hat{F}_X, \hat{\Sigma}_{F_X} ) $
            \State $\hat{M}$.append(TargetFunction($\hat{F}_{X, k}$))
        \EndFor
    \State $m =$ TargetFunction($F_X$)
    \State $\hat{m} = $mean($\hat{M}$)
    \State $ci = (\text{quantile}_{\alpha}(\hat{M}), \text{quantile}_{1-\alpha}(\hat{M}))$
    \State CiCoverageList.append($ ci\left[0\right] < m < ci\left[1\right]$)
    \State CiWidthList.append($ci\left[1\right] - ci\left[0\right]$)
    \EndFor
    \State CiCoverage = mean(CiCoverageList)
    \State CiWidth = mean(CiWidthList)
\end{algorithmic}
\end{algorithm}


Simulation of true BP signal and measurements:
    \begin{itemize}
        \item $X=\{x_1, \dots x_n\}$: The time points of interest, which is one week of data with 10 BP values per hour.
        \item $f_X := \{f(x_1) \dots f(x_n)\}$: The true BP signal $f(x)$ drawn from $GP(0, k_{true}(x,x'))$ evaluated at inputs $X$.
        \item $y_X := \{y(x_1) \dots y(x_n)\}$: The noisy BP measurements. $y(x)= f(x) + \epsilon$ with $\epsilon \sim N(0, \sigma_n^2)$
    \end{itemize}

Based on subsampling scheme choose $X_{train} \subset X$ with $|X_{train}| = m$ and $X_{test} = X \setminus X_{train}$.
\begin{itemize}
    \item $y_{train} := \{y(x_i) | x_i \in X_{train}\}$
    \item  $f_{train} := \{f(x_i) | x_i \in X_{train}\}$
\end{itemize}


	Fit GP regression model to training data $y_{train}$, $X_{train}$:
    \begin{itemize}
        \item $k_{fit}$: The fitted kernel function with hyperparameters $\theta$ that maximizes the marginal likelihood
        $p(y_{train}| \theta)$
        \item $p(f_X| y_{train}, k_{fit}) = N(\bar{\mu}, \bar{\Sigma})$:
        The posterior (predictive) probability density of $f_X$. The posterior mean vector
        $\bar{\mu} \in \mathbb{R}^n$ contains the point estimates for $f_X$.
        \begin{itemize}
            \item $\bar{\mu}_{train} := \{\bar{\mu}_i | x_i \in X_{train}\}$
            \item $\bar{\Sigma}_{train} := \bar{\Sigma}_{i,j}$ where $\{i | x_i \in X_{train}\}$ and $\{j | x_j \in X_{train}\}$

        \end{itemize}
    \end{itemize}

	Output of GP Regression are predictive probabilities $p(f_{train}| y_{train})$,
		$p(f_{test}| y_{train})$ and $p(f_{X}| y_{train})$:
			\begin{itemize}
				\item Note $\bar{\mu}_{train} \neq f_{train}$ due to the measurement error. \\ If
				$f_{train}$ was known: $p(f_{train}| f_{train}, GP_{fit}) = N(\bar{\mu}_{X_{train}},
				\bar{\Sigma}_{X_{train}})$
				with $\bar{\mu}_{train} = f_{train}$ and $\bar{\Sigma}_{train} = {\displaystyle O}$
			\end{itemize}



\section{Baseline Methods}\label{sec:baseline-methods}


\section{Target Measures}\label{sec:target-measures}

\subsection{Time in Target Range}




\section{Performance Metrics}\label{sec:performance-metric}




















